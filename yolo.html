<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Visual Novel - Full Features</title>
    <style>
        /* --- 1. C·∫•u h√¨nh chung --- */
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #000;
        }

        /* --- 2. L·ªõp N·ªÅn (Background Layer) --- */
        /* T√°ch ri√™ng n·ªÅn ra div ri√™ng ƒë·ªÉ d·ªÖ l√†m hi·ªáu ·ª©ng chuy·ªÉn c·∫£nh */
        #bg-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-size: cover;
            background-position: center;
            z-index: 0;
            transition: opacity 0.5s ease-in-out; /* Hi·ªáu ·ª©ng m·ªù d·∫ßn khi ƒë·ªïi c·∫£nh */
        }

        /* --- 3. Nh√¢n v·∫≠t --- */
        #character {
            position: absolute;
            bottom: 0; left: 50%;
            transform: translateX(-50%);
            height: 90%;
            transition: opacity 0.2s ease-in-out;
            filter: drop-shadow(0 0 10px rgba(255,255,255,0.3));
            z-index: 5;
            opacity: 1;
        }
        #character.fading { opacity: 0; } /* Class ·∫©n nh√¢n v·∫≠t khi ƒë·ªïi bi·ªÉu c·∫£m */

        /* --- 4. H·ªôp tho·∫°i --- */
        #dialogue-box {
            position: absolute;
            bottom: 20px; left: 50%;
            transform: translateX(-50%);
            width: 80%; max-width: 800px; height: 150px;
            background: rgba(0, 0, 0, 0.8);
            border: 2px solid #fff;
            border-radius: 15px;
            padding: 20px;
            color: white;
            z-index: 10;
            display: none;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        #name-tag {
            font-weight: bold; font-size: 1.2em; color: #ffcc00;
            margin-bottom: 10px; text-shadow: 1px 1px 2px black;
        }
        #text-content { font-size: 1.1em; line-height: 1.5; }

        /* --- 5. N√∫t l·ª±a ch·ªçn --- */
        #choices-container {
            position: absolute;
            top: 40%; left: 50%;
            transform: translate(-50%, -50%);
            display: flex; flex-direction: column;
            gap: 15px; z-index: 20;
            width: 100%; align-items: center;
        }
        .choice-btn {
            background: linear-gradient(90deg, rgba(0,0,0,0.8) 0%, rgba(56,56,56,0.9) 100%);
            color: white; border: 1px solid rgba(255,255,255,0.5);
            padding: 15px 30px; font-size: 1.2em; cursor: pointer;
            border-radius: 50px; transition: 0.3s; min-width: 300px;
        }
        .choice-btn:hover {
            background: rgba(255, 255, 255, 0.9); color: black;
            transform: scale(1.05); box-shadow: 0 0 15px #fff;
        }

      
        #music-control {
            position: absolute;
            top: 20px; right: 20px;
            z-index: 100;
            background: rgba(0,0,0,0.6);
            border: 1px solid white;
            color: white;
            padding: 10px 15px;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            display: none; /* Hi·ªán khi game b·∫Øt ƒë·∫ßu */
        }
        #music-control:hover { background: white; color: black; }

        /* --- 7. M√†n h√¨nh Start --- */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 100; color: white; font-size: 2em;
            cursor: pointer; flex-direction: column;
        }
    </style>
</head>
<body>

    <audio id="bgm" loop>
        <source src="Cry For Me (feat. ÊÑõÊµ∑).mp3" type="audio/mpeg">
    </audio>

    <audio id="voice-channel"></audio>

    <div id="game-container">
        <div id="bg-layer" style="background-image: url('https://tse2.mm.bing.net/th/id/OIP.fATGsJ0_GTGmiRA14p95wwHaEK?rs=1&pid=ImgDetMain&o=7&rm=3');"></div>

        <img id="character" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Character">

        <div id="choices-container"></div>

        <div id="dialogue-box">
            <div id="name-tag">Waifu</div>
            <div id="text-content">...</div>
        </div>

        <button id="music-control" onclick="toggleMusic()">üéµ T·∫Øt Nh·∫°c</button>

        <div id="start-screen" onclick="startGame()">
            CLICK ƒê·ªÇ B·∫ÆT ƒê·∫¶U
            <p style="font-size: 0.5em; color: #ccc;">(B·∫≠t √¢m thanh & V√†o game)</p>
        </div>
    </div>

    <script>
        // --- T√ÄI NGUY√äN (Thay link c·ªßa b·∫°n v√†o ƒë√¢y) ---
        
        // 1. ·∫¢nh Bi·ªÉu C·∫£m
        const poses = {
            "normal": "https://upload.wikimedia.org/wikipedia/en/2/23/Kizuna_AI.png",
            "happy": "https://i.pinimg.com/originals/2e/99/12/2e991207bb5390c8745538b7c47508d2.png",
            "sad": "https://i.pinimg.com/originals/0b/ac/6c/0bac6c05777557839707771000251084.png"
        };

        // 2. ·∫¢nh N·ªÅn (Backgrounds)
        const bgs = {
            "school": "https://tse2.mm.bing.net/th/id/OIP.fATGsJ0_GTGmiRA14p95wwHaEK?rs=1&pid=ImgDetMain&o=7&rm=3", // C·∫£nh tr∆∞·ªùng h·ªçc
            "park": "https://tse2.mm.bing.net/th/id/OIP.GFe6V84vcYDDqjAEWMrtpwHaEK?pid=ImgDet&w=474&h=266&rs=1&o=7&rm=3", // C·∫£nh c√¥ng vi√™n
            "restaurant": "https://images.unsplash.com/photo-1550966871-3ed3c47e2ce2?q=80&w=1920&auto=format&fit=crop" // C·∫£nh nh√† h√†ng
        };

        
        const story = {
            "start": {
                pose: poses.normal,
                background: bgs.school, // B·ªëi c·∫£nh tr∆∞·ªùng h·ªçc
                voice: "voice_hello.mp3", // Link file gi·ªçng n√≥i (n·∫øu c√≥)
                text: "Ch√†o c·∫≠u! C·∫≠u ƒë√£ ƒë·∫øn tr∆∞·ªùng s·ªõm th·∫ø? H√¥m nay tr·ªùi ƒë·∫πp nh·ªâ?",
                next: [
                    { text: "·ª™, tr·ªùi ƒë·∫πp th·∫≠t!", target: "happy_path" },
                    { text: "T√¥i th·∫•y b√¨nh th∆∞·ªùng.", target: "neutral_path" }
                ]
            },
            "happy_path": {
                pose: poses.happy,
                background: bgs.park, // CHUY·ªÇN C·∫¢NH -> C√¥ng vi√™n
                voice: "voice_happy.mp3",
                text: "Hihi, c·∫≠u ƒë·ªìng √Ω l√† t·ªõ vui r·ªìi! Ch√∫ng ta ƒëang ·ªü c√¥ng vi√™n r·ªìi n√†y!",
                next: [
                    { text: "ƒêi d·∫°o th√¥i!", target: "end_date" },
                    { text: "V·ªÅ l·ªõp th√¥i.", target: "end_lazy" }
                ]
            },
            "neutral_path": {
                pose: poses.normal,
                background: bgs.restaurant, // CHUY·ªÇN C·∫¢NH -> Nh√† h√†ng
                voice: "", // Kh√¥ng c√≥ gi·ªçng n√≥i ƒëo·∫°n n√†y
                text: "C·∫≠u l·∫°nh l√πng qu√° √†... Hay l√† ch√∫ng ta v√†o nh√† h√†ng ƒÉn g√¨ ƒë√≥ nh√©?",
                next: [
                    { text: "·ª™, ƒëi ƒÉn.", target: "end_eat" }
                ]
            },
            // C√°c k·∫øt th√∫c
            "end_date": { pose: poses.happy, background: bgs.park, text: "Tuy·ªát v·ªùi! Bu·ªïi h·∫πn h√≤ b·∫Øt ƒë·∫ßu! (K·∫øt th√∫c)", next: null },
            "end_lazy": { pose: poses.sad, background: bgs.school, text: "Ti·∫øc gh√™... Th√¥i h·∫πn c·∫≠u h√¥m sau nha. (K·∫øt th√∫c)", next: null },
            "end_eat": { pose: poses.happy, background: bgs.restaurant, text: "M√¨ ·ªü ƒë√¢y ngon tuy·ªát v·ªùi! (K·∫øt th√∫c)", next: null }
        };

        // --- H·ªÜ TH·ªêNG ---
        const bgLayer = document.getElementById("bg-layer");
        const characterImg = document.getElementById("character");
        const textElement = document.getElementById("text-content");
        const choiceContainer = document.getElementById("choices-container");
        const dialogueBox = document.getElementById("dialogue-box");
        const bgm = document.getElementById("bgm");
        const voiceChannel = document.getElementById("voice-channel");
        const musicBtn = document.getElementById("music-control");
        const startScreen = document.getElementById("start-screen");

        let isMusicPlaying = false;

        // --- 1. KH·ªûI ƒê·ªòNG ---
        function startGame() {
            startScreen.style.display = "none";
            dialogueBox.style.display = "block";
            musicBtn.style.display = "block";
            
            // B·∫≠t nh·∫°c n·ªÅn
            bgm.volume = 0.4;
            bgm.play().then(() => {
                isMusicPlaying = true;
                updateMusicBtn();
            }).catch(e => console.log("L·ªói nh·∫°c n·ªÅn:", e));

            showNode("start");
        }

        // --- 2. X·ª¨ L√ù H·ªòI THO·∫†I & S·ª∞ KI·ªÜN ---
        function showNode(nodeId) {
            const node = story[nodeId];
            
            // A. X·ª¨ L√ù GI·ªåNG N√ìI (VOICE)
            if (node.voice && node.voice !== "") {
                voiceChannel.src = node.voice;
                voiceChannel.play().catch(e => console.log("L·ªói ph√°t gi·ªçng n√≥i (c√≥ th·ªÉ do link sai):", e));
            } else {
                voiceChannel.pause(); // D·ª´ng gi·ªçng n√≥i c≈© n·∫øu ƒëo·∫°n m·ªõi kh√¥ng c√≥ tho·∫°i
                voiceChannel.currentTime = 0;
            }

            // B. X·ª¨ L√ù CHUY·ªÇN C·∫¢NH (BACKGROUND)
            // Ki·ªÉm tra xem ƒëo·∫°n n√†y c√≥ background m·ªõi kh√¥ng, v√† c√≥ kh√°c background hi·ªán t·∫°i kh√¥ng
            const currentBgUrl = bgLayer.style.backgroundImage.slice(5, -2).replace(/"/g, "");
            if (node.background && currentBgUrl !== node.background) {
                // Hi·ªáu ·ª©ng m·ªù ƒëi
                bgLayer.style.opacity = 0;
                setTimeout(() => {
                    bgLayer.style.backgroundImage = `url('${node.background}')`;
                    bgLayer.style.opacity = 1; // Hi·ªán l·∫°i
                }, 500); // 500ms kh·ªõp v·ªõi css transition
            }

            // C. X·ª¨ L√ù BI·ªÇU C·∫¢M (POSE)
            if (node.pose && characterImg.src !== node.pose) {
                characterImg.classList.add("fading");
                setTimeout(() => {
                    characterImg.src = node.pose;
                    characterImg.classList.remove("fading");
                }, 200);
            }

            // D. HI·ªÇN TH·ªä TEXT & L·ª∞A CH·ªåN
            choiceContainer.innerHTML = "";
            typeWriter(node.text, 0, () => {
                if (node.next) {
                    node.next.forEach(choice => {
                        const btn = document.createElement("button");
                        btn.innerText = choice.text;
                        btn.className = "choice-btn";
                        btn.onclick = () => showNode(choice.target);
                        choiceContainer.appendChild(btn);
                    });
                } else {
                    const btn = document.createElement("button");
                    btn.innerText = "Ch∆°i l·∫°i";
                    btn.className = "choice-btn";
                    btn.onclick = () => location.reload(); // T·∫£i l·∫°i trang cho nhanh
                    choiceContainer.appendChild(btn);
                }
            });
        }

        // --- 3. CH·ª®C NƒÇNG B·∫¨T/T·∫ÆT NH·∫†C ---
        function toggleMusic() {
            if (isMusicPlaying) {
                bgm.pause();
                isMusicPlaying = false;
            } else {
                bgm.play();
                isMusicPlaying = true;
            }
            updateMusicBtn();
        }

        function updateMusicBtn() {
            musicBtn.innerText = isMusicPlaying ? "üéµ T·∫Øt Nh·∫°c" : "üîá B·∫≠t Nh·∫°c";
        }

        // --- 4. HI·ªÜU ·ª®NG G√ï CH·ªÆ ---
        let typingTimeout;
        function typeWriter(text, i, callback) {
            if (i === 0) {
                textElement.innerHTML = "";
                clearTimeout(typingTimeout);
            }
            if (i < text.length) {
                textElement.innerHTML += text.charAt(i);
                typingTimeout = setTimeout(() => {
                    typeWriter(text, i + 1, callback);
                }, 30); 
            } else {
                if(callback) callback();
            }
        }
    </script>
</body>
</html>